<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Five</title>
  <style>
    body {
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #f0f0f0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 20px;
    }
    h1 { 
      color: #00fff7;
      font-size: 2.5em;
      text-shadow: 0 0 10px #00fff7;
    }
    .channels { display: flex; justify-content: center; gap: 12px; margin: 20px 0; flex-wrap: wrap; }
    button {
      background: #111;
      border: 1px solid #333;
      border-radius: 10px;
      color: #f0f0f0;
      padding: 12px 24px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s;
      box-shadow: 0 0 8px rgba(0,255,247,0.4);
    }
    button:hover { background-color: #00fff7; color: #111; box-shadow: 0 0 15px #00fff7; }
    .controls { margin: 20px 0; }
    .visualizer { display: flex; align-items: flex-end; height: 60px; gap: 4px; justify-content: center; margin-top: 20px; }
    .bar { width: 6px; background: #00fff7; height: 5px; transition: height 0.1s; border-radius: 2px; }
    #participants { margin-top: 20px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto; background: rgba(0,0,0,0.4); padding: 12px; border-radius: 10px; }
    #participants h3 { color: #00fff7; margin-bottom: 8px; }
    .participant { display: flex; align-items: center; margin-bottom: 5px; }
    .indicator { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    .on { background: #0f0; }
    .off { background: #f00; }
  </style>
</head>
<body>
  <h1>Five</h1>
  <p>Select a channel to join the audio conference:</p>

  <div class="channels">
    <button onclick="joinChannel(1)">1</button>
    <button onclick="joinChannel(2)">2</button>
    <button onclick="joinChannel(3)">3</button>
    <button onclick="joinChannel(4)">4</button>
    <button onclick="joinChannel(5)">5</button>
  </div>
  
  <div class="controls">
    <button onclick="toggleMic()">üé§ Mic ON/OFF</button>
    <input type="range" id="volume" min="0" max="1" step="0.01" value="1" onchange="setVolume(this.value)">
  </div>

  <div class="visualizer" id="visualizer"></div>

  <div id="participants">
    <h3>Connected participants</h3>
    <div id="list"></div>
  </div>

  <!-- PeerJS Library -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script>
    // --- 1. CONFIGURATION FIREBASE ---
    // TODO: Remplacez ceci par la configuration de VOTRE projet Firebase
    const firebaseConfig = {
      apiKey: "AIza...",
      authDomain: "your-project-id.firebaseapp.com",
      databaseURL: "https://your-project-id-default-rtdb.firebaseio.com",
      projectId: "your-project-id",
      storageBucket: "your-project-id.appspot.com",
      messagingSenderId: "...",
      appId: "..."
    };

    // --- 2. INITIALISATION ---
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let localStream = null;
    let peer = null;
    let peers = {}; // Stocke les objets d'appel (calls)
    let audioElements = {}; // Stocke les √©l√©ments <audio>
    let currentChannel = null;
    let currentChannelRef = null; // R√©f√©rence √† la base de donn√©es pour le canal actuel
    let micEnabled = true;
    const bars = [];

    // Setup visualizer
    for (let i = 0; i < 32; i++) {
      const bar = document.createElement('div');
      bar.classList.add('bar');
      document.getElementById('visualizer').appendChild(bar);
      bars.push(bar);
    }

    async function joinChannel(channelNum) {
      if (currentChannel === channelNum) return;

      playBeep();

      // --- 3. NETTOYAGE DE L'ANCIEN CANAL ---
      if (peer) {
        // Se retire de l'ancien canal dans Firebase
        if (currentChannelRef) {
          currentChannelRef.child(peer.id).remove();
          currentChannelRef.off(); // Arr√™te d'√©couter les √©v√©nements
        }
        peer.destroy();
      }
      // Nettoyage de l'interface
      document.getElementById('list').innerHTML = '';
      for(const id in audioElements) {
        removeParticipant(id);
      }
      peers = {};
      audioElements = {};


      // --- 4. OBTENTION DU FLUX AUDIO LOCAL ---
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        setupVisualizer(localStream);
      } catch (err) {
        alert("Impossible d'acc√©der au microphone. Veuillez v√©rifier les autorisations.");
        console.error("getUserMedia error:", err);
        return;
      }

      currentChannel = channelNum;
      currentChannelRef = database.ref('channels/channel-' + currentChannel);
      
      // --- 5. INITIALISATION DE PeerJS ---
      peer = new Peer({
        // Utilise les serveurs STUN/TURN publics de Google, parfaitement dans l'√©cosyst√®me
        config: {
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" },
          ]
        }
      });

      peer.on('open', (id) => {
        console.log('My peer ID is: ' + id);
        addParticipant(id, true);

        // --- 6. SIGNALISATION VIA FIREBASE ---
        // S'annonce dans le canal
        const myRef = currentChannelRef.child(id);
        myRef.onDisconnect().remove(); // Tr√®s important: se supprime si l'onglet est ferm√©
        myRef.set(true);

        // √âcoute les autres participants qui rejoignent
        currentChannelRef.on('child_added', (snapshot) => {
          const newPeerId = snapshot.key;
          if (newPeerId === id || peers[newPeerId]) return; // Ne pas s'appeler soi-m√™me ou un pair d√©j√† connect√©
          
          console.log(`D√©couverte d'un nouveau pair: ${newPeerId}, je l'appelle.`);
          const call = peer.call(newPeerId, localStream);
          setupCallHandlers(call);
        });

        // √âcoute les participants qui partent
        currentChannelRef.on('child_removed', (snapshot) => {
          const removedPeerId = snapshot.key;
          if (peers[removedPeerId]) {
            console.log(`Le pair ${removedPeerId} a quitt√© le canal.`);
            removeParticipant(removedPeerId);
          }
        });
      });

      // R√©pond aux appels entrants
      peer.on('call', (call) => {
        console.log(`R√©ception d'un appel de ${call.peer}`);
        call.answer(localStream);
        playBeep();
        setupCallHandlers(call);
      });

      peer.on('error', (err) => console.error('PeerJS error:', err));
    }

    function setupCallHandlers(call) {
      const remotePeerId = call.peer;
      peers[remotePeerId] = call;

      call.on('stream', (remoteStream) => {
        console.log(`R√©ception du flux audio de ${remotePeerId}`);
        playStream(remotePeerId, remoteStream);
      });

      call.on('close', () => removeParticipant(remotePeerId));
      call.on('error', () => removeParticipant(remotePeerId));
    }

    function playStream(id, stream) {
      if (audioElements[id]) return;

      const audio = document.createElement('audio');
      audio.srcObject = stream;
      audio.playsInline = true;
      audio.volume = document.getElementById('volume').value;
      
      // La lecture est initi√©e apr√®s l'interaction de l'utilisateur (clic sur le canal)
      audio.play().catch(error => console.error(`La lecture auto a √©chou√© pour ${id}:`, error));
      
      audioElements[id] = audio;
      addParticipant(id, false);
    }

    // Fonctions utilitaires (inchang√©es)
    function toggleMic() {
      if (!localStream) return;
      micEnabled = !micEnabled;
      localStream.getAudioTracks()[0].enabled = micEnabled;
      if (peer) updateMicIndicator(peer.id, micEnabled);
    }

    function setVolume(val) {
      for (let id in audioElements) {
        audioElements[id].volume = val;
      }
    }

    function setupVisualizer(stream) {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioCtx.createAnalyser();
        const source = audioCtx.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 64;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        function draw() {
            if(!localStream || !micEnabled) {
                bars.forEach(bar => bar.style.height = '5px');
                requestAnimationFrame(draw);
                return;
            };
            requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);
            for (let i = 0; i < bars.length; i++) {
                bars[i].style.height = (dataArray[i] / 2) + 'px';
            }
        }
        draw();
    }

    function addParticipant(id, isSelf) {
      if (document.getElementById('p-' + id)) return;
      const div = document.createElement('div');
      div.classList.add('participant');
      div.id = 'p-' + id;
      const indicator = document.createElement('div');
      indicator.classList.add('indicator', (isSelf && micEnabled) ? 'on' : 'off');
      div.appendChild(indicator);
      div.appendChild(document.createTextNode(isSelf ? `Moi (${id.substring(0, 8)}...)` : `${id.substring(0, 8)}...`));
      document.getElementById('list').appendChild(div);
    }

    function removeParticipant(id) {
      const div = document.getElementById('p-' + id);
      if (div) div.remove();
      
      if (audioElements[id]) {
        audioElements[id].pause();
        audioElements[id].srcObject = null;
        delete audioElements[id];
      }
      if (peers[id]) {
        peers[id].close();
        delete peers[id];
      }
    }

    function updateMicIndicator(id, state) {
      const participant = document.getElementById('p-' + id);
      if (participant) {
        const indicator = participant.querySelector('.indicator');
        indicator.className = 'indicator ' + (state ? 'on' : 'off');
      }
    }

    function playBeep() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(600, ctx.currentTime);
      g.gain.setValueAtTime(0.05, ctx.currentTime);
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + 0.15);
    }
  </script>
</body>
</html>