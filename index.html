<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Five - Final Version</title>
  <style>
    body { background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: #f0f0f0; font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; margin: 0; }
    h1 { color: #00fff7; font-size: 2.5em; text-shadow: 0 0 10px #00fff7; }
    button { background: #111; border: 1px solid #333; border-radius: 10px; color: #f0f0f0; padding: 12px 24px; cursor: pointer; font-size: 1em; transition: all 0.3s; box-shadow: 0 0 8px rgba(0,255,247,0.4); }
    button:hover { background-color: #00fff7; color: #111; box-shadow: 0 0 15px #00fff7; }
    button:disabled { cursor: not-allowed; opacity: 0.5; }
    .hidden { display: none; }
    #app-container { display: flex; flex-direction: column; align-items: center; }
    #unlock-audio-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 100; }
    #unlock-audio-container button { font-size: 1.5em; padding: 20px 40px; }
    .channels { display: flex; justify-content: center; gap: 12px; margin: 20px 0; flex-wrap: wrap; }
    .controls { margin: 20px 0; }
    .visualizer { display: flex; align-items: flex-end; height: 60px; gap: 4px; justify-content: center; margin-top: 20px; }
    .bar { width: 6px; background: #00fff7; height: 5px; transition: height 0.1s; border-radius: 2px; }
    #participants { margin-top: 20px; text-align: left; max-width: 400px; width: 90%; margin-left: auto; margin-right: auto; background: rgba(0,0,0,0.4); padding: 12px; border-radius: 10px; }
    #participants h3 { color: #00fff7; margin-bottom: 8px; }
    .participant { display: flex; align-items: center; margin-bottom: 5px; }
    .indicator { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; flex-shrink: 0; }
    .on { background: #0f0; } .off { background: #f00; }
    .geo-options { margin: 15px 0; }
  </style>
</head>
<body>

  <!-- Ã‰cran de dÃ©verrouillage audio -->
  <div id="unlock-audio-container">
    <button onclick="unlockAudioContext()">ðŸ”Š Entrer dans Five</button>
  </div>

  <div id="app-container" class="hidden">
    <h1>Five</h1>
    <p>Select a channel to join the audio conference:</p>

    <div class="geo-options">
      <label><input type="radio" name="radius" value="5"> Limite 5 km</label>
      <label style="margin-left:15px;"><input type="radio" name="radius" value="25" checked> Limite 25 km</label>
    </div>

    <div class="channels">
      <button onclick="joinChannel(1)">1</button>
      <button onclick="joinChannel(2)">2</button>
      <button onclick="joinChannel(3)">3</button>
      <button onclick="joinChannel(4)">4</button>
      <button onclick="joinChannel(5)">5</button>
    </div>
    
    <div class="controls">
      <button onclick="toggleMic()">ðŸŽ¤ Mic ON/OFF</button>
      <input type="range" id="volume" min="0" max="1" step="0.01" value="1" onchange="setVolume(this.value)">
    </div>

    <div class="visualizer" id="visualizer"></div>

    <div id="participants">
      <h3>Participants connectÃ©s</h3>
      <div id="list"></div>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script>
    // --- 1. CONFIGURATION FIREBASE ---
    // TODO: Remplacez par votre configuration Firebase
    const firebaseConfig = {
      apiKey: "AIza...",
      authDomain: "your-project-id.firebaseapp.com",
      databaseURL: "https://your-project-id-default-rtdb.firebaseio.com",
      projectId: "your-project-id",
      storageBucket: "your-project-id.appspot.com",
      messagingSenderId: "...",
      appId: "..."
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- 2. VARIABLES GLOBALES ---
    let localStream, peer, currentChannel, currentChannelRef, userLocation;
    let peers = {};
    let audioElements = {};
    let micEnabled = true;
    const bars = [];
    let audioContextUnlocked = false;

    // --- 3. LOGIQUE DE L'APPLICATION ---
    
    // Ã‰tape 2 : DÃ©verrouillage du contexte audio
    function unlockAudioContext() {
        if (audioContextUnlocked) return;
        const context = new (window.AudioContext || window.webkitAudioContext)();
        // Joue un son silencieux pour activer le contexte
        const source = context.createBufferSource();
        source.buffer = context.createBuffer(1, 1, 22050);
        source.connect(context.destination);
        source.start(0);
        
        // GÃ¨re les Ã©tats "suspendus" sur certains navigateurs
        if (context.state === 'suspended') {
            context.resume();
        }
        
        audioContextUnlocked = true;
        console.log("Audio Context unlocked.");
        document.getElementById('unlock-audio-container').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
    }

    // Initialisation du visualiseur
    for (let i = 0; i < 32; i++) {
        const bar = document.createElement('div');
        bar.classList.add('bar');
        document.getElementById('visualizer').appendChild(bar);
        bars.push(bar);
    }
    
    function joinChannel(channelNum) {
        if (!audioContextUnlocked) {
            alert("Veuillez d'abord cliquer sur 'Entrer' pour activer l'audio.");
            return;
        }
        document.querySelectorAll('.channels button').forEach(b => b.disabled = true);
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = { lat: position.coords.latitude, lon: position.coords.longitude };
                startConference(channelNum);
            },
            (error) => {
                alert("GÃ©olocalisation requise. Veuillez l'autoriser.");
                document.querySelectorAll('.channels button').forEach(b => b.disabled = false);
            }
        );
    }

    async function startConference(channelNum) {
      playBeep();
      if (peer) {
        if (currentChannelRef) currentChannelRef.child(peer.id).remove();
        peer.destroy();
      }
      document.getElementById('list').innerHTML = '';
      Object.values(audioElements).forEach(audio => audio.remove());
      peers = {}; audioElements = {};

      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        setupVisualizer(localStream);
      } catch (err) {
        alert("Impossible d'accÃ©der au microphone.");
        return;
      }

      currentChannel = channelNum;
      currentChannelRef = database.ref('channels/channel-' + currentChannel);
      
      // Ã‰tape 1 : Configuration rÃ©seau robuste
      const iceConfig = {
          iceServers: [
              { urls: "stun:stun.l.google.com:19302" },
              { urls: "stun:stun1.l.google.com:19302" },
              // Serveurs TURN de secours (service public pour test)
              {
                  urls: "turn:openrelay.metered.ca:80",
                  username: "openrelayproject",
                  credential: "openrelayproject"
              },
              {
                  urls: "turn:openrelay.metered.ca:443",
                  username: "openrelayproject",
                  credential: "openrelayproject"
              }
          ]
      };

      peer = new Peer({ config: iceConfig });

      peer.on('open', (id) => {
        console.log("PeerJS initialisÃ© avec l'ID:", id);
        addParticipant(id, true);
        const myData = { lat: userLocation.lat, lon: userLocation.lon };
        const myRef = currentChannelRef.child(id);
        myRef.onDisconnect().remove();
        myRef.set(myData);

        currentChannelRef.on('child_added', (snapshot) => {
          const newPeerId = snapshot.key;
          const peerData = snapshot.val();
          if (newPeerId === id || peers[newPeerId]) return;

          const distance = haversineDistance(userLocation, peerData);
          const selectedRadius = document.querySelector('input[name="radius"]:checked').value;
          
          if (distance <= selectedRadius) {
              console.log(`Appel du pair ${newPeerId} qui est Ã  portÃ©e.`);
              const call = peer.call(newPeerId, localStream, { metadata: { location: userLocation } });
              setupCallHandlers(call);
          }
        });
        currentChannelRef.on('child_removed', (snapshot) => removeParticipant(snapshot.key));
      });

      peer.on('call', (call) => {
        const callerLocation = call.metadata.location;
        const distance = haversineDistance(userLocation, callerLocation);
        const selectedRadius = document.querySelector('input[name="radius"]:checked').value;

        if (distance <= selectedRadius) {
            console.log(`RÃ©ponse Ã  l'appel de ${call.peer} qui est Ã  portÃ©e.`);
            call.answer(localStream);
            playBeep();
            setupCallHandlers(call);
        } else {
            console.log(`Rejet de l'appel de ${call.peer}, hors de portÃ©e.`);
        }
      });
      peer.on('error', (err) => console.error('Erreur PeerJS:', err));
      document.querySelectorAll('.channels button').forEach(b => b.disabled = false);
    }

    function setupCallHandlers(call) {
      console.log(`Configuration des handlers pour l'appel avec ${call.peer}`);
      const remotePeerId = call.peer;
      peers[remotePeerId] = call;
      call.on('stream', (remoteStream) => {
          console.log(`FLUX REÃ‡U de ${remotePeerId}!`);
          playStream(remotePeerId, remoteStream);
      });
      call.on('close', () => removeParticipant(remotePeerId));
      call.on('error', (err) => {
          console.error(`Erreur d'appel avec ${remotePeerId}:`, err);
          removeParticipant(remotePeerId);
      });
    }

    function playStream(id, stream) {
      if (audioElements[id]) return;
      console.log(`Tentative de lecture du flux pour ${id}`);
      const audio = document.createElement('audio');
      document.body.appendChild(audio);
      audio.srcObject = stream;
      audio.playsInline = true; // Crucial pour iOS
      audio.volume = document.getElementById('volume').value;
      const playPromise = audio.play();

      if (playPromise !== undefined) {
        playPromise.then(_ => {
          console.log(`LECTURE RÃ‰USSIE pour ${id}`);
        }).catch(error => {
          console.error(`ERREUR DE LECTURE pour ${id}:`, error);
          alert("Le navigateur a bloquÃ© la lecture automatique du son. Essayez d'interagir avec la page.");
        });
      }
      
      audioElements[id] = audio;
      addParticipant(id, false);
    }

    // --- Fonctions utilitaires ---
    const haversineDistance = (coords1, coords2) => {
        const toRad = x => x * Math.PI / 180;
        const R = 6371;
        const dLat = toRad(coords2.lat - coords1.lat);
        const dLon = toRad(coords2.lon - coords1.lon);
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(coords1.lat)) * Math.cos(toRad(coords2.lat)) * Math.sin(dLon / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    };
    const removeParticipant = id => {
      document.getElementById('p-' + id)?.remove();
      if (audioElements[id]) {
        audioElements[id].remove();
        delete audioElements[id];
      }
      if (peers[id]) {
        peers[id].close();
        delete peers[id];
      }
    };
    // Copiez les fonctions toggleMic, setVolume, setupVisualizer, addParticipant, updateMicIndicator, playBeep de la version prÃ©cÃ©dente, elles sont inchangÃ©es.
    function toggleMic() {if(!localStream)return;micEnabled=!micEnabled;localStream.getAudioTracks()[0].enabled=micEnabled;if(peer)updateMicIndicator(peer.id,micEnabled);}
    function setVolume(val){for(let id in audioElements){audioElements[id].volume=val;}}
    function setupVisualizer(stream){const a=new(window.AudioContext||window.webkitAudioContext)(),b=a.createAnalyser(),c=a.createMediaStreamSource(stream);c.connect(b),b.fftSize=64;const d=b.frequencyBinCount,e=new Uint8Array(d);!function f(){if(localStream){requestAnimationFrame(f),b.getByteFrequencyData(e);for(let g=0;g<bars.length;g++)bars[g].style.height=(micEnabled?e[g]/2:5)+"px"}}();}
    function addParticipant(id,isSelf){if(document.getElementById("p-"+id))return;const a=document.createElement("div");a.className="participant",a.id="p-"+id;const b=document.createElement("div");b.className="indicator "+(isSelf&&micEnabled?"on":"off"),a.appendChild(b),a.appendChild(document.createTextNode(isSelf?`Moi (${id.substring(0,8)}...)`:`${id.substring(0,8)}...`)),document.getElementById("list").appendChild(a);}
    function updateMicIndicator(id,state){const a=document.getElementById("p-"+id);if(a){const b=a.querySelector(".indicator");b.className="indicator "+(state?"on":"off");}}
    function playBeep(){const a=new(window.AudioContext||window.webkitAudioContext)(),b=a.createOscillator(),c=a.createGain();b.type="sine",b.frequency.setValueAtTime(600,a.currentTime),c.gain.setValueAtTime(.05,a.currentTime),b.connect(c),c.connect(a.destination),b.start(),b.stop(a.currentTime+.15);}
  </script>
</body>
</html>