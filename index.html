<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Five - Geo & Audio Fix</title>
  <style>
    body {
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #f0f0f0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 20px;
    }
    h1 { 
      color: #00fff7;
      font-size: 2.5em;
      text-shadow: 0 0 10px #00fff7;
    }
    .channels { display: flex; justify-content: center; gap: 12px; margin: 20px 0; flex-wrap: wrap; }
    button {
      background: #111;
      border: 1px solid #333;
      border-radius: 10px;
      color: #f0f0f0;
      padding: 12px 24px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s;
      box-shadow: 0 0 8px rgba(0,255,247,0.4);
    }
    button:hover { background-color: #00fff7; color: #111; box-shadow: 0 0 15px #00fff7; }
    button:disabled { cursor: not-allowed; opacity: 0.5; }
    .controls { margin: 20px 0; }
    .visualizer { display: flex; align-items: flex-end; height: 60px; gap: 4px; justify-content: center; margin-top: 20px; }
    .bar { width: 6px; background: #00fff7; height: 5px; transition: height 0.1s; border-radius: 2px; }
    #participants { margin-top: 20px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto; background: rgba(0,0,0,0.4); padding: 12px; border-radius: 10px; }
    #participants h3 { color: #00fff7; margin-bottom: 8px; }
    .participant { display: flex; align-items: center; margin-bottom: 5px; }
    .indicator { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    .on { background: #0f0; }
    .off { background: #f00; }
    .geo-options { margin: 15px 0; }
  </style>
</head>
<body>
  <h1>Five (Geo & Audio Fix)</h1>
  <p>Select a channel to join the audio conference:</p>

  <div class="geo-options">
    <label><input type="radio" name="radius" value="5"> Limite 5 km</label>
    <label style="margin-left:15px;"><input type="radio" name="radius" value="25" checked> Limite 25 km</label>
  </div>

  <div class="channels">
    <button onclick="joinChannel(1)">1</button>
    <button onclick="joinChannel(2)">2</button>
    <button onclick="joinChannel(3)">3</button>
    <button onclick="joinChannel(4)">4</button>
    <button onclick="joinChannel(5)">5</button>
  </div>
  
  <div class="controls">
    <button onclick="toggleMic()">üé§ Mic ON/OFF</button>
    <input type="range" id="volume" min="0" max="1" step="0.01" value="1" onchange="setVolume(this.value)">
  </div>

  <div class="visualizer" id="visualizer"></div>

  <div id="participants">
    <h3>Connected participants</h3>
    <div id="list"></div>
  </div>

  <!-- PeerJS Library -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script>
    // --- 1. CONFIGURATION FIREBASE ---
    // TODO: Remplacez ceci par la configuration de VOTRE projet Firebase
    const firebaseConfig = {
      apiKey: "AIza...",
      authDomain: "your-project-id.firebaseapp.com",
      databaseURL: "https://your-project-id-default-rtdb.firebaseio.com",
      projectId: "your-project-id",
      storageBucket: "your-project-id.appspot.com",
      messagingSenderId: "...",
      appId: "..."
    };

    // --- 2. INITIALISATION ---
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let localStream = null;
    let peer = null;
    let peers = {}; // Stocke les objets d'appel (calls)
    let audioElements = {}; // Stocke les √©l√©ments <audio>
    let currentChannel = null;
    let currentChannelRef = null;
    let micEnabled = true;
    let userLocation = null; // Stockera {lat, lon}
    const bars = [];

    // Setup visualizer
    for (let i = 0; i < 32; i++) {
        const bar = document.createElement('div');
        bar.classList.add('bar');
        document.getElementById('visualizer').appendChild(bar);
        bars.push(bar);
    }
    
    function joinChannel(channelNum) {
        document.querySelectorAll('.channels button').forEach(b => b.disabled = true);
        
        // 1. Obtenir la g√©olocalisation d'abord
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                };
                console.log("Location obtained:", userLocation);
                // Une fois la localisation obtenue, on continue
                startConference(channelNum);
            },
            (error) => {
                alert("Impossible d'obtenir la g√©olocalisation. Veuillez l'autoriser pour utiliser l'application.");
                console.error("Geolocation error:", error);
                document.querySelectorAll('.channels button').forEach(b => b.disabled = false);
            }
        );
    }

    async function startConference(channelNum) {
      if (currentChannel === channelNum) return;
      playBeep();
      
      if (peer) {
        if (currentChannelRef) {
            currentChannelRef.child(peer.id).remove();
            currentChannelRef.off();
        }
        peer.destroy();
      }
      document.getElementById('list').innerHTML = '';
      Object.values(audioElements).forEach(audio => audio.remove());
      peers = {};
      audioElements = {};

      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        setupVisualizer(localStream);
      } catch (err) {
        alert("Impossible d'acc√©der au microphone.");
        return;
      }

      currentChannel = channelNum;
      currentChannelRef = database.ref('channels/channel-' + currentChannel);
      
      peer = new Peer({
        config: { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] }
      });

      peer.on('open', (id) => {
        addParticipant(id, true);
        const myData = { lat: userLocation.lat, lon: userLocation.lon };
        const myRef = currentChannelRef.child(id);
        myRef.onDisconnect().remove();
        myRef.set(myData);

        currentChannelRef.on('child_added', (snapshot) => {
          const newPeerId = snapshot.key;
          const peerData = snapshot.val();
          if (newPeerId === id || peers[newPeerId]) return;

          const distance = haversineDistance(userLocation, peerData);
          const selectedRadius = document.querySelector('input[name="radius"]:checked').value;
          
          if (distance <= selectedRadius) {
              console.log(`Peer ${newPeerId} is in range (${distance.toFixed(2)} km). Calling.`);
              // On envoie notre position pour que l'autre puisse v√©rifier √† son tour
              const call = peer.call(newPeerId, localStream, { metadata: { location: userLocation } });
              setupCallHandlers(call);
          } else {
              console.log(`Peer ${newPeerId} is out of range (${distance.toFixed(2)} km). Ignoring.`);
          }
        });

        currentChannelRef.on('child_removed', (snapshot) => {
          removeParticipant(snapshot.key);
        });
      });

      peer.on('call', (call) => {
        const callerLocation = call.metadata.location;
        const distance = haversineDistance(userLocation, callerLocation);
        const selectedRadius = document.querySelector('input[name="radius"]:checked').value;

        if (distance <= selectedRadius) {
            console.log(`Answering call from ${call.peer}, who is in range.`);
            call.answer(localStream);
            playBeep();
            setupCallHandlers(call);
        } else {
            console.log(`Rejecting call from ${call.peer}, out of range.`);
            // On ne fait rien, l'appel sera en timeout pour l'appelant.
        }
      });

      peer.on('error', (err) => console.error('PeerJS error:', err));
      document.querySelectorAll('.channels button').forEach(b => b.disabled = false);
    }

    function setupCallHandlers(call) {
      const remotePeerId = call.peer;
      peers[remotePeerId] = call;
      call.on('stream', (remoteStream) => playStream(remotePeerId, remoteStream));
      call.on('close', () => removeParticipant(remotePeerId));
      call.on('error', () => removeParticipant(remotePeerId));
    }

    function playStream(id, stream) {
      if (audioElements[id]) return;

      const audio = document.createElement('audio');
      // **CORRECTION AUDIO CRUCIALE** : L'√©l√©ment doit √™tre dans le DOM pour une lecture fiable.
      document.body.appendChild(audio);
      audio.srcObject = stream;
      audio.playsInline = true;
      audio.autoplay = true; // Renforce l'intention de jouer le son
      audio.volume = document.getElementById('volume').value;
      
      audio.play().catch(error => console.error(`La lecture auto a √©chou√© pour ${id}:`, error));
      
      audioElements[id] = audio;
      addParticipant(id, false);
    }

    function removeParticipant(id) {
        const div = document.getElementById('p-' + id);
        if (div) div.remove();
        
        if (audioElements[id]) {
            audioElements[id].pause();
            audioElements[id].srcObject = null;
            // **CORRECTION NETTOYAGE** : On retire l'√©l√©ment audio du DOM
            document.body.removeChild(audioElements[id]);
            delete audioElements[id];
        }
        if (peers[id]) {
            peers[id].close();
            delete peers[id];
        }
    }
    
    function haversineDistance(coords1, coords2) {
        function toRad(x) { return x * Math.PI / 180; }
        const R = 6371; // Rayon de la Terre en km
        const dLat = toRad(coords2.lat - coords1.lat);
        const dLon = toRad(coords2.lon - coords1.lon);
        const lat1 = toRad(coords1.lat);
        const lat2 = toRad(coords2.lat);

        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // --- Fonctions utilitaires (peu ou pas modifi√©es) ---
    function toggleMic() { /* ... (inchang√©) ... */ }
    function setVolume(val) { /* ... (inchang√©) ... */ }
    function setupVisualizer(stream) { /* ... (inchang√©) ... */ }
    function addParticipant(id, isSelf) { /* ... (inchang√©) ... */ }
    function updateMicIndicator(id, state) { /* ... (inchang√©) ... */ }
    function playBeep() { /* ... (inchang√©) ... */ }

    // On recopie les fonctions utilitaires ici pour que le code soit complet
    function toggleMic() {
      if (!localStream) return;
      micEnabled = !micEnabled;
      localStream.getAudioTracks()[0].enabled = micEnabled;
      if (peer) updateMicIndicator(peer.id, micEnabled);
    }
    function setVolume(val) {
      for (let id in audioElements) { audioElements[id].volume = val; }
    }
    function setupVisualizer(stream) {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const analyser = audioCtx.createAnalyser();
      const source = audioCtx.createMediaStreamSource(stream);
      source.connect(analyser);
      analyser.fftSize = 64;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      function draw() {
        if (!localStream) return;
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);
        for (let i = 0; i < bars.length; i++) {
          bars[i].style.height = (micEnabled ? dataArray[i] / 2 : 5) + 'px';
        }
      }
      draw();
    }
    function addParticipant(id, isSelf) {
      if (document.getElementById('p-' + id)) return;
      const div = document.createElement('div');
      div.classList.add('participant');
      div.id = 'p-' + id;
      const indicator = document.createElement('div');
      indicator.classList.add('indicator', (isSelf && micEnabled) ? 'on' : 'off');
      div.appendChild(indicator);
      div.appendChild(document.createTextNode(isSelf ? `Moi (${id.substring(0, 8)}...)` : `${id.substring(0, 8)}...`));
      document.getElementById('list').appendChild(div);
    }
    function updateMicIndicator(id, state) {
      const participant = document.getElementById('p-' + id);
      if (participant) {
        const indicator = participant.querySelector('.indicator');
        indicator.className = 'indicator ' + (state ? 'on' : 'off');
      }
    }
    function playBeep() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine"; o.frequency.setValueAtTime(600, ctx.currentTime);
      g.gain.setValueAtTime(0.05, ctx.currentTime);
      o.connect(g); g.connect(ctx.destination);
      o.start(); o.stop(ctx.currentTime + 0.15);
    }
  </script>
</body>
</html>